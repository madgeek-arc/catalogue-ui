<div #panel class="uk-position-relative comments-panel">

  @let positions = positions$ | async;
  @let heights = heights$ | async;


  @if (positions && heights && observablesReady) {
    @for (thread of sectionThreads; track thread.id) {
      <div
        class="thread-wrapper uk-position-absolute uk-width-expand"
        [class.thread--focused]="thread.id === focusedThreadId"
        [style.top.px]="layoutMap.get(thread.id)?.top ?? 0"
        (click)="onThreadClick(thread)">
        <div measureComment [threadId]="thread.id"
             (sizeChange)="onCommentSizeChange(thread.id, $event)"
             class="uk-card uk-card-default uk-card-small uk-animation-slide-top-medium comment-card">
          <div class="uk-card-body">
            <div class="comment-header">
              <strong>{{ thread.fieldId }}</strong><br>
<!--              <strong>{{ thread.id }}</strong><br>-->
              top - {{ layoutMap.get(thread.id)?.top}}
            </div>
            <div class="comment-messages">
              @for (comment of thread.messages; track comment.id) {
                <p class="uk-margin-remove-top">->{{ comment.body }}</p>
              }

              @if (!showInputMap.get(thread.id)) {
                <div class="uk-flex uk-flex-right">
                  <a class="material-symbols-outlined uk-text-decoration-none" style="font-size: 24px"
                     (click)="toggleInput(thread.id)">reply
                  </a>
                </div>
              } @else {
                <div class="uk-flex uk-flex-middle">
                  <!-- Input fields inside forms trigger form submission by default when Enter is pressed.
                       This is standard HTML behavior as per HTML5 spec for backward compatibility. -->
                  <div class="uk-width-auto uk-margin-xsmall-right">
                    <input class="uk-input uk-padding-xsmall" type="text" placeholder="Reply"
                           [(ngModel)]="inputMessage" (keydown.enter)="$event.preventDefault()">
                  </div>
                  <div class="uk-width-auto">
                    <a class="material-symbols-outlined uk-text-decoration-none" style="font-size: 24px"
                       (click)="sendComment(thread.id)">send
                    </a>
                  </div>
                </div>
              }
            </div>
          </div>
        </div>
      </div>
    }
  } @else {
    <div class="uk-text-center">Loading...</div>
  }
</div>
